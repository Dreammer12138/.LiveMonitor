#!/usr/bin/python3
import json
import os
import time
import sys, getopt
import datetime

opts, args = getopt.getopt(sys.argv[1:], "l:", ["log=", "upgrade"])

liveon = 'on'
liveoff = 'off'
record = 'off'
path = os.path.dirname(os.path.abspath(__file__))
log_out = path
logis = 0

config_file = open(path + '/roomid.json', encoding = "utf-8")
room = json.loads(config_file.read())['user']
check = 'sudo ' + path + '/Monitor-check'

#网络检测
try :
    net = os.system("ping -c 4 -q live.bilibili.com")
    if net :
        print("Network connect failed, Please check the network enviroment")
        sys.exit()
    else :
        pass
except Exception as e :
    sys.exit()
    log.write("[" + time.strftime('%Y-%m-%d %H:%M:%S') + "]{}发生错误,错误信息:{}\n".format(datetime.now(), e))

#参数检测
try:
    for opt, val in opts :
        if opt in ("-l", "--log") :
            log_out = val
        if opt in ("--upgrade") :
            os.system("sudo pip3 install --upgrade streamlink")
            os.system("cd /usr/DDMonitor")
            os.system("sudo git pull")
except getopt.GetoptError as e:
    sys.exit()

#循环监听
try :
    while True:
        t = time.strftime('%Y-%m-%d_%H:%M:%S',time.localtime(time.time()))
        log = ""
        for uid in room :
            file_name = '{}_{}.mp4'.format(uid['nickname'], t)
            out = os.popen(check + " " + uid['uid']).read().strip()
            if liveoff == out and record == 'off' and logis == 0 :
                log = "[" + time.strftime('%Y-%m-%d %H:%M:%S') + "]"
                print('正在监听{}'.format(uid['nickname']))
                log += "正在监听{}".format(uid['nickname'])
                logis = 1
                log += "\n"
            if liveon == out and record == 'off' :
                log = "[" + time.strftime('%Y-%m-%d %H:%M:%S') + "]"
                print("Start recording {} in {}".format(file_name, t))
                record = 'on'
                log += os.popen('streamlink -O https://live.bilibili.com/' + uid['uid'] + ' best | ffmpeg -loglevel error -i pipe:0 -vcodec copy -acodec copy -vbsf h264_mp4toannexb /mnt/harddisk/video/Kaguramea/' + file_name).read().strip()
                logis = 0
                log += '\n'
            elif liveoff == out :
                record = 'off'
        logfile = open(log_out + '/log', encoding = 'utf-8', mode = 'a+')
        logfile.write(log)
except Exception as e:
    with open(log_out + '/log', "a+") as log :
        log.write("[" + time.strftime('%Y-%m-%d %H:%M:%S') + "]{}发生错误,错误信息:{}\n".format(time.localtime(time.time()), e))
